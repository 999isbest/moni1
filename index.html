<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ç½‘ç»œè¡¨è¾¾æ¨¡æ‹Ÿä½“éªŒ-åˆ›æ„è¡¨è¾¾</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: "Microsoft YaHei", "PingFang SC", sans-serif;
            background: #f8f9fa radial-gradient(circle at 50% 50%, rgba(255,240,200,0.8) 0%, #fff 100%);
            overflow: hidden;
            transition: background-color 0.5s ease, box-shadow 0.5s ease, filter 0.5s ease;
            position: relative;
        }

        /* æ¸¸æˆèƒœåˆ©åæ˜¾ç¤ºé¼ æ ‡/è§¦æ‘¸å…‰æ ‡ */
        body.game-ended {
            cursor: default !important;
        }

        /* æ¸¸æˆè¿è¡Œä¸­éšè—é¼ æ ‡ï¼ˆç”µè„‘ç«¯ï¼‰ */
        body.game-running {
            cursor: none !important;
        }

        /* åŠ¨æ€å…‰æ–‘èƒŒæ™¯ */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.45' numOctaves='2' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.05'/%3E%3C/svg%3E");
            pointer-events: none;
            z-index: -1;
            animation: noiseMove 8s infinite linear;
        }

        @keyframes noiseMove {
            0% { transform: translate(0, 0); }
            50% { transform: translate(-5px, -5px); }
            100% { transform: translate(0, 0); }
        }

        /* å–œæ‚¦å‘¼å¸æ•ˆæœ */
        @keyframes joyBreath {
            0% { filter: brightness(1); }
            50% { filter: brightness(1.2); }
            100% { filter: brightness(1); }
        }

        /* æ¬¢ç¬‘å€¼å®¹å™¨ - å±…ä¸­ä¸Šæ–¹ï¼ˆç§»åŠ¨ç«¯é€‚é…å®½åº¦ï¼‰ */
        .joy-container {
            position: fixed;
            top: 20px; /* ç§»åŠ¨ç«¯å‡å°‘é¡¶éƒ¨é—´è· */
            left: 50%;
            transform: translateX(-50%);
            width: 90%; /* ç§»åŠ¨ç«¯ä½¿ç”¨ç™¾åˆ†æ¯”å®½åº¦ï¼Œæœ€å¤§ä¸è¶…è¿‡600px */
            max-width: 600px;
            height: 35px; /* ç§»åŠ¨ç«¯ç•¥å¾®ç¼©å°é«˜åº¦ */
            background-color: rgba(255, 255, 255, 0.8);
            border: 3px solid #ffcc00;
            border-radius: 20px;
            overflow: hidden;
            z-index: 100;
            box-shadow: 0 0 20px rgba(255, 204, 0, 0.3);
            backdrop-filter: blur(10px);
            transition: transform 0.1s ease;
        }

        /* æ¬¢ç¬‘å€¼è¿›åº¦ */
        .joy-bar {
            width: 0%;
            height: 100%;
            background: linear-gradient(90deg, #FFD700, #FFA500);
            transition: width 0.3s ease, background 0.3s ease;
            position: relative;
        }

        .joy-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                to right,
                rgba(255,255,255,0.2) 0%,
                rgba(255,255,255,0.4) 50%,
                rgba(255,255,255,0.2) 100%
            );
            animation: shimmer 2s infinite linear;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        /* æ¬¢ç¬‘å€¼æ–‡å­—æç¤ºï¼ˆç§»åŠ¨ç«¯é€‚é…ï¼‰ */
        .joy-text {
            position: fixed;
            top: 25px; /* å¯¹åº”æ¬¢ç¬‘å€¼å®¹å™¨é—´è· */
            left: 50%;
            transform: translateX(-50%);
            color: #ff8c00;
            font-size: 16px; /* ç§»åŠ¨ç«¯ç¼©å°å­—ä½“ */
            font-weight: bold;
            z-index: 101;
            text-shadow: 0 0 8px rgba(255, 255, 255, 0.8);
            transition: transform 0.1s ease;
        }

        /* æ¸¸æˆç”»å¸ƒï¼ˆå¼ºåˆ¶å æ»¡å±å¹•ï¼Œç§»åŠ¨ç«¯å»é™¤å¤šä½™è¾¹è·ï¼‰ */
        #gameCanvas {
            display: block;
            width: 100vw;
            height: 100vh;
            background-color: rgba(255, 255, 255, 0.1);
            transition: filter 0.2s ease, transform 0.1s ease;
            touch-action: none; /* ç¦æ­¢ç§»åŠ¨ç«¯è§¦æ‘¸é»˜è®¤è¡Œä¸ºï¼ˆå¦‚ç¼©æ”¾ã€æ»šåŠ¨ï¼‰ */
        }

        /* æ¸¸æˆèƒœåˆ©å¼¹çª—ï¼ˆç§»åŠ¨ç«¯é€‚é…å®½åº¦å’Œå†…è¾¹è·ï¼‰ */
        .game-win {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(255, 255, 255, 0.98);
            color: #ff8c00;
            padding: 30px 20px; /* ç§»åŠ¨ç«¯å‡å°‘å†…è¾¹è· */
            width: 90%; /* ç§»åŠ¨ç«¯ç™¾åˆ†æ¯”å®½åº¦ */
            max-width: 500px; /* é™åˆ¶æœ€å¤§å®½åº¦ */
            border-radius: 15px;
            text-align: center;
            z-index: 200;
            display: none;
            border: 2px solid #ffcc00;
            box-shadow: 0 0 30px rgba(255, 204, 0, 0.5);
            animation: fadeIn 0.5s ease forwards;
        }

        /* æ¸¸æˆå¼€å§‹å¼¹çª—ï¼ˆç§»åŠ¨ç«¯é€‚é…ï¼‰ */
        .game-start {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(255, 255, 255, 0.98);
            color: #ff8c00;
            padding: 30px 20px; /* ç§»åŠ¨ç«¯å‡å°‘å†…è¾¹è· */
            width: 90%; /* ç§»åŠ¨ç«¯ç™¾åˆ†æ¯”å®½åº¦ */
            max-width: 500px; /* é™åˆ¶æœ€å¤§å®½åº¦ */
            border-radius: 15px;
            text-align: center;
            z-index: 300; /* å±‚çº§é«˜äºå…¶ä»–å…ƒç´  */
            border: 2px solid #ffcc00;
            box-shadow: 0 0 30px rgba(255, 204, 0, 0.5);
            animation: fadeIn 0.5s ease forwards;
        }

        @keyframes fadeIn {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
            100% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        }

        .game-start h2 {
            color: #ff8c00;
            margin-bottom: 10px;
            font-size: 28px; /* ç§»åŠ¨ç«¯ç¼©å°å­—ä½“ */
            text-shadow: 0 0 10px rgba(255, 140, 0, 0.5);
        }

        .game-start .sub-title {
            color: #ff6666;
            font-size: 20px; /* ç§»åŠ¨ç«¯ç¼©å°å­—ä½“ */
            margin-bottom: 20px;
            font-weight: bold;
        }

        .game-win h2, .game-start h3 {
            color: #ff8c00;
            margin-bottom: 20px;
            font-size: 28px; /* ç§»åŠ¨ç«¯ç¼©å°å­—ä½“ */
            text-shadow: 0 0 10px rgba(255, 140, 0, 0.5);
        }

        .game-win p, .game-start p {
            font-size: 16px; /* ç§»åŠ¨ç«¯ç¼©å°å­—ä½“ */
            margin-bottom: 25px;
            line-height: 1.8;
            color: #333;
        }

        .game-win button, .game-start button {
            padding: 10px 30px; /* ç§»åŠ¨ç«¯ç¼©å°æŒ‰é’®å†…è¾¹è· */
            font-size: 18px; /* ç§»åŠ¨ç«¯ç¼©å°æŒ‰é’®å­—ä½“ */
            background: linear-gradient(90deg, #FFD700, #FFA500);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.4);
            touch-action: manipulation; /* æŒ‰é’®è§¦æ‘¸ä¼˜åŒ–ï¼Œé˜²æ­¢åŒå‡»ç¼©æ”¾ */
        }

        .game-win button:hover, .game-start button:hover {
            background: linear-gradient(90deg, #FFA500, #FF8C00);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 215, 0, 0.6);
        }

        .game-win button:focus, .game-start button:focus {
            outline: 3px solid #FFD700;
            outline-offset: 2px;
        }

        /* æ¸¸æˆè¯´æ˜ï¼ˆç§»åŠ¨ç«¯é€‚é…ï¼Œè°ƒæ•´ä½ç½®å’Œå¤§å°ï¼‰ */
        .instructions {
            position: fixed;
            bottom: 120px; /* å¯¹åº”è¯„è®ºå¡ç‰‡é—´è· */
            left: 50%;
            transform: translateX(-50%);
            color: #ff8c00;
            font-size: 12px; /* ç§»åŠ¨ç«¯ç¼©å°å­—ä½“ */
            text-align: center;
            z-index: 100;
            background-color: rgba(255, 255, 255, 0.8);
            padding: 8px 15px; /* ç§»åŠ¨ç«¯ç¼©å°å†…è¾¹è· */
            border-radius: 20px;
            backdrop-filter: blur(5px);
            transition: transform 0.1s ease;
            text-shadow: 0 0 3px #fff;
            width: 90%; /* ç§»åŠ¨ç«¯ç™¾åˆ†æ¯”å®½åº¦ */
            max-width: 500px;
        }

        /* è¯„è®ºå¡ç‰‡æ ·å¼ï¼ˆç§»åŠ¨ç«¯é€‚é…å®½åº¦å’Œé«˜åº¦ï¼‰ */
        .comment-card {
            position: fixed;
            bottom: 15px; /* ç§»åŠ¨ç«¯å‡å°‘åº•éƒ¨é—´è· */
            left: 50%;
            transform: translateX(-50%);
            width: 90%; /* ç§»åŠ¨ç«¯ç™¾åˆ†æ¯”å®½åº¦ */
            max-width: 550px;
            height: auto; /* ç§»åŠ¨ç«¯è‡ªåŠ¨é«˜åº¦ï¼Œé€‚é…å†…å®¹ */
            min-height: 90px; /* é™åˆ¶æœ€å°é«˜åº¦ */
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 15px; /* ç§»åŠ¨ç«¯å‡å°‘å†…è¾¹è· */
            display: flex;
            align-items: center;
            gap: 15px; /* ç§»åŠ¨ç«¯å‡å°‘é—´è· */
            box-shadow: 0 0 20px rgba(255, 204, 0, 0.2);
            z-index: 100;
            border: 2px solid #ffdd99;
            backdrop-filter: blur(10px);
            transition: all 0.2s ease;
        }

        /* è¯„è®ºå¤´åƒï¼ˆç§»åŠ¨ç«¯ç¼©å°ï¼‰ */
        .comment-avatar {
            width: 60px; /* ç§»åŠ¨ç«¯ç¼©å°å¤´åƒ */
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px; /* ç§»åŠ¨ç«¯ç¼©å°å­—ä½“ */
            color: white;
            font-weight: bold;
            box-shadow: 0 0 15px rgba(255, 204, 0, 0.3);
            transition: all 0.3s ease;
            flex-shrink: 0; /* é˜²æ­¢å¤´åƒè¢«å‹ç¼© */
        }

        /* å¤´åƒè„‰å†²åŠ¨ç”» */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        /* è¯„è®ºå†…å®¹åŒºåŸŸ */
        .comment-content {
            flex: 1;
            color: #333;
        }

        .comment-author {
            font-size: 16px; /* ç§»åŠ¨ç«¯ç¼©å°å­—ä½“ */
            font-weight: bold;
            margin-bottom: 8px;
            transition: color 0.3s ease;
        }

        .comment-text {
            font-size: 15px; /* ç§»åŠ¨ç«¯ç¼©å°å­—ä½“ */
            line-height: 1.5;
            color: #555;
            text-shadow: 0 1px 3px rgba(255, 255, 255, 0.5);
            word-wrap: break-word; /* ç§»åŠ¨ç«¯è‡ªåŠ¨æ¢è¡Œï¼Œé˜²æ­¢æ–‡å­—æº¢å‡º */
        }

        /* é—ªçƒæ•ˆæœç±» */
        .flash-effect {
            filter: brightness(1.3) contrast(1.2);
        }

        /* ç²’å­æ•ˆæœæ ·å¼ */
        .particle {
            position: absolute;
            border-radius: 50%;
            pointer-events: none;
            animation: particleFade 1s ease forwards;
        }

        @keyframes particleFade {
            0% { opacity: 1; transform: scale(1); }
            100% { opacity: 0; transform: scale(0); }
        }

        /* ç§»åŠ¨ç«¯æ§åˆ¶å°çƒï¼ˆé»˜è®¤éšè—ï¼Œæ¸¸æˆè¿è¡Œæ—¶æ˜¾ç¤ºï¼‰ */
        .control-ball {
            position: fixed;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: linear-gradient(135deg, #FFD700, #FF8C00);
            box-shadow: 0 0 15px rgba(255, 140, 0, 0.8);
            pointer-events: none; /* ä¸é˜»æŒ¡è§¦æ‘¸äº‹ä»¶ */
            z-index: 90; /* ä½äºå…¶ä»–UIï¼Œé«˜äºç”»å¸ƒ */
            display: none; /* åˆå§‹éšè— */
            touch-action: none;
        }
    </style>
</head>
<body>
    <!-- æ¸¸æˆå¼€å§‹å¼¹çª— -->
    <div class="game-start" id="gameStart">
        <h2>åˆ›æ„è¡¨è¾¾</h2>
        <div class="sub-title">æ‰¹åˆ¤å¯¹è±¡ï¼šâ€œäº‹â€</div>
        <p> 
            æ‹–åŠ¨å°çƒç§»åŠ¨<br>
            æ”¶é›†ç»¿è‰²æš–å¿ƒè¨€å¼¹<br>
            èº²é¿çº¢è‰²è´Ÿé¢è¨€å¼¹
        </p>
        <button onclick="startGame()">å¼€å§‹æ¨¡æ‹Ÿ</button>
    </div>

    <!-- æ¬¢ç¬‘å€¼åŒºåŸŸ -->
    <div class="joy-container" id="joyContainer">
        <div class="joy-bar" id="joyBar"></div>
    </div>
    <div class="joy-text" id="joyText">æ¬¢ç¬‘å€¼: 0</div>

    <!-- æ¸¸æˆç”»å¸ƒ -->
    <canvas id="gameCanvas"></canvas>

    <!-- ç§»åŠ¨ç«¯æ§åˆ¶å°çƒ -->
    <div class="control-ball" id="controlBall"></div>

    <!-- æ¸¸æˆèƒœåˆ©å¼¹çª— -->
    <div class="game-win" id="gameWin">
        <h2>æ¨¡æ‹Ÿç»“æŸ</h2>
        <p>åœ¨æ¸©æš–çš„ç½‘ç»œæ°›å›´ä¸­ï¼Œä½ æ”¶è·äº†æ»¡æ»¡çš„å¿«ä¹<br>å³ä½¿æœ‰ä¸åŒçš„è§‚ç‚¹ï¼Œä¹Ÿèƒ½é€šè¿‡åˆ›æ„è¡¨è¾¾æ„‰å¿«è®¨è®ºï¼</p>
        <button onclick="confirmGameWin()">ç¡®è®¤</button>
    </div>

    <!-- æ¸¸æˆè¯´æ˜ -->
    <div class="instructions" id="instructions">
        ç°è‰²=è·¯äºº(æ— æ•ˆæœ) | çº¢è‰²=è´Ÿé¢è¨€è®º(å‡æ¬¢ç¬‘å€¼) | ç»¿è‰²=æš–å¿ƒè¯è¯­(åŠ æ¬¢ç¬‘å€¼)<br>
        æ”¶é›†ç»¿è‰²è¨€å¼¹ï¼Œèº²é¿çº¢è‰²è¨€å¼¹ï¼Œç§¯ç´¯æ¬¢ç¬‘å€¼åˆ°100å³å¯èƒœåˆ©
    </div>

    <!-- è¯„è®ºå¡ç‰‡ -->
    <div class="comment-card" id="commentCard">
        <div class="comment-avatar" id="commentAvatar">ğŸ˜</div>
        <div class="comment-content">
            <div class="comment-author" id="commentAuthor">è·¯äºº</div>
            <div class="comment-text" id="commentText">ç­‰å¾…äº’åŠ¨...</div>
        </div>
    </div>

    <script>
        // ========== éŸ³é¢‘èµ„æºåˆå§‹åŒ– ==========
        const audio = {
            hitRed: new Audio('https://assets.mixkit.co/sfx/preview/mixkit-sad-trombone-471.mp3'),
            hitGreen: new Audio('https://assets.mixkit.co/sfx/preview/mixkit-achievement-bell-600.mp3'),
            hitGray: new Audio('https://assets.mixkit.co/sfx/preview/mixkit-select-click-1109.mp3'),
            gameWin: new Audio('https://assets.mixkit.co/sfx/preview/mixkit-arcade-game-jump-coin-216.mp3'),
            bgm: new Audio('https://assets.mixkit.co/music/preview/mixkit-happy-ukulele-1184.mp3')
        };

        // å…¨å±€æ‰“å­—æœºå®šæ—¶å™¨ï¼Œç”¨äºä¸­æ–­é‡å¤è¯„è®º
        let typingTimer = null;

        // åˆå§‹åŒ–éŸ³é¢‘è®¾ç½®
        function initAudio() {
            audio.bgm.loop = true;
            audio.bgm.volume = 0.3;
            audio.hitRed.volume = 0.4;
            audio.hitGreen.volume = 0.6;
            audio.hitGray.volume = 0.3;
            audio.gameWin.volume = 0.7;

            // é¡µé¢äº¤äº’åæ’­æ”¾èƒŒæ™¯éŸ³ä¹ï¼ˆå…¼å®¹æµè§ˆå™¨ç­–ç•¥ï¼‰
            document.addEventListener('click', () => {
                audio.bgm.play().catch(e => console.log('éŸ³é¢‘è‡ªåŠ¨æ’­æ”¾å—é™ï¼Œç‚¹å‡»é¡µé¢ä»»æ„ä½ç½®å³å¯æ’­æ”¾'));
            }, { once: true });
        }

        // ========== DOMå…ƒç´ è·å– ==========
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const joyBar = document.getElementById('joyBar');
        const joyText = document.getElementById('joyText');
        const gameWinModal = document.getElementById('gameWin');
        const gameStartModal = document.getElementById('gameStart');
        const commentAvatar = document.getElementById('commentAvatar');
        const commentAuthor = document.getElementById('commentAuthor');
        const commentText = document.getElementById('commentText');
        const joyContainer = document.getElementById('joyContainer');
        const instructions = document.getElementById('instructions');
        const commentCard = document.getElementById('commentCard');
        const body = document.body;
        const controlBall = document.getElementById('controlBall'); // ç§»åŠ¨ç«¯æ§åˆ¶å°çƒ

        // ========== æ¸¸æˆå‚æ•° ==========
        let canvasWidth = window.innerWidth;
        let canvasHeight = window.innerHeight;
        let joy = 0; // æ¬¢ç¬‘å€¼ï¼Œåˆå§‹0ï¼Œä¸Šé™100
        let mouseX = canvasWidth / 2;
        let mouseY = canvasHeight / 2;
        let bullets = [];
        let gameTime = 0;
        let gameRunning = false; // åˆå§‹ä¸ºfalseï¼Œç‚¹å‡»å¼€å§‹åè®¾ä¸ºtrue
        let isJoy40Triggered = false; // æ¬¢ç¬‘å€¼è¶…è¿‡40è§¦å‘è§†è§‰æ•ˆæœ
        let shakeInterval = null;
        let flashInterval = null;
        let lastFrameTime = 0; // å¸§ç‡æ§åˆ¶
        let is18SecondsTriggered = false; // æ ‡è®°18ç§’å·¨é‡ç»¿å¼¹æ˜¯å¦å·²è§¦å‘
        let isTouchDevice = /Mobile|Android|iOS|iPad|iPhone|iPod|Windows Phone|BlackBerry/.test(navigator.userAgent); // åˆ¤æ–­æ˜¯å¦ä¸ºç§»åŠ¨è®¾å¤‡

        // è·³è½¬ç›®æ ‡ç½‘å€ï¼ˆå¯è‡ªè¡Œä¿®æ”¹ï¼‰
        const TARGET_URL = "https://999isbest.github.io/moni2/";

        // ========== åˆ†é˜¶æ®µè¯„è®ºåº“ ==========
        const commentLibrary = {
            // é˜¶æ®µ1ï¼šå‰10ç§’
            stage1: {
                gray: ["è·¯è¿‡~", "å“ˆå“ˆå“ˆæœ‰æ„æ€", "éšä¾¿çœ‹çœ‹", "ä»Šå¤©å¤©æ°”ä¸é”™"],
                red: ["ç½‘ç»œç¬‘è¯æ¥çš„", "å°±è¿™ï¼Ÿ", "æ²¡è§‰å¾—å¤šå¥½", "é€†å¤©å‘è¨€ï¼"],
                green: ["å“ˆå“ˆå“ˆéœ‡æ’¼é¦–å‘ï¼", "å¤ªå¯çˆ±äº†â¤ï¸", "è€å¸ˆä½ çš„å‚è€ƒæ–‡çŒ®åœ¨å“ªé‡Œï¼Ÿ", "ç¬‘ç…æˆ‘ä¹Ÿï¼"]
            },
            // é˜¶æ®µ2ï¼š10-30ç§’
            stage2: {
                gray: ["è·¯è¿‡~", "å“ˆå“ˆå“ˆæœ‰æ„æ€", "éšä¾¿çœ‹çœ‹", "ä»Šå¤©å¤©æ°”ä¸é”™"],
                red: ["ç½‘ç»œç¬‘è¯æ¥çš„", "å“ªé‡Œå¥½ç¬‘äº†ï¼Ÿ", "å°±è¿™ï¼Ÿ", "è£…çš„å§"],
                green: ["å“ˆå“ˆå“ˆéœ‡æ’¼é¦–å‘ï¼", "è€å¸ˆä½ çš„å‚è€ƒæ–‡çŒ®åœ¨å“ªé‡Œï¼Ÿ", "çœŸæ£’ï¼"]
            },
            // é˜¶æ®µ3ï¼š30ç§’å
            stage3: {
                gray: ["è·¯è¿‡~", "å“ˆå“ˆå“ˆæœ‰æ„æ€", "éšä¾¿çœ‹çœ‹", "ä»Šå¤©å¤©æ°”ä¸é”™"],
                red: ["å“ªé‡Œå¥½ç¬‘äº†ï¼Ÿ", "é€†å¤©å‘è¨€ï¼", "ç½‘ç»œç¬‘è¯æ¥çš„", "ä¹Ÿå°±é‚£æ ·å§"],
                green: ["ä½ çš„å¿«ä¹æ„ŸæŸ“åˆ°æˆ‘äº†âœ¨", "è€å¸ˆä½ çš„å‚è€ƒæ–‡çŒ®åœ¨å“ªé‡Œï¼Ÿ", "å“ˆå“ˆå“ˆéœ‡æ’¼é¦–å‘ï¼", "å¤ªé…·å•¦"]
            }
        };

        // ========== å·¥å…·å‡½æ•° ==========
        // è°ƒæ•´ç”»å¸ƒå¤§å°
        function resizeCanvas() {
            canvasWidth = window.innerWidth;
            canvasHeight = window.innerHeight;
            canvas.width = canvasWidth;
            canvas.height = canvasHeight;
            
            // è‹¥æœªè§¦æ‘¸ï¼Œä¿æŒå…‰æ ‡åœ¨å±å¹•ä¸­å¤®
            if (!gameRunning || (isTouchDevice && !isTouching)) {
                mouseX = canvasWidth / 2;
                mouseY = canvasHeight / 2;
                updateControlBallPosition();
            }
        }

        // æ›´æ–°ç§»åŠ¨ç«¯æ§åˆ¶å°çƒä½ç½®
        function updateControlBallPosition() {
            if (!isTouchDevice) return;
            controlBall.style.left = `${mouseX - controlBall.offsetWidth / 2}px`;
            controlBall.style.top = `${mouseY - controlBall.offsetHeight / 2}px`;
        }

        // è·å–åˆ†é˜¶æ®µéšæœºè¯„è®º
        function getRandomComment(type) {
            let stage;
            if (gameTime < 600) stage = 'stage1';
            else if (gameTime < 1800) stage = 'stage2';
            else stage = 'stage3';

            const comments = commentLibrary[stage][type] || commentLibrary.stage1[type];
            return comments[Math.floor(Math.random() * comments.length)];
        }

        // åˆ›å»ºç¢°æ’ç²’å­æ•ˆæœ
        function createParticles(x, y, type) {
            const particleCount = 15;
            const colors = {
                gray: '#cccccc',
                red: '#ff6666',
                green: '#99cc00'
            };

            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = `${x}px`;
                particle.style.top = `${y}px`;
                particle.style.width = `${5 + Math.random() * 10}px`;
                particle.style.height = particle.style.width;
                particle.style.backgroundColor = colors[type];
                particle.style.opacity = '0.8';

                const angle = Math.random() * Math.PI * 2;
                const speed = 2 + Math.random() * 5;
                const dx = Math.cos(angle) * speed;
                const dy = Math.sin(angle) * speed;

                let startTime = Date.now();
                function updateParticle() {
                    const elapsed = Date.now() - startTime;
                    if (elapsed > 1000) {
                        particle.remove();
                        return;
                    }

                    particle.style.left = `${x + dx * elapsed / 20}px`;
                    particle.style.top = `${y + dy * elapsed / 20}px`;
                    requestAnimationFrame(updateParticle);
                }

                document.body.appendChild(particle);
                requestAnimationFrame(updateParticle);
            }
        }

        // æ›´æ–°èƒŒæ™¯é¢œè‰²å’Œè§†è§‰æ„‰æ‚¦æ„Ÿ
        function updateBackgroundColor() {
            // æ¬¢ç¬‘å€¼0 â†’ æµ…ç™½è‰²ï¼›æ¬¢ç¬‘å€¼100 â†’ é‡‘é»„è‰²
            const red = Math.floor(255 - (joy / 100) * 50);
            const green = Math.floor(240 + (joy / 100) * 15);
            const blue = Math.floor(200 + (joy / 100) * 55);
            body.style.backgroundColor = `#${red.toString(16).padStart(2, '0')}${green.toString(16).padStart(2, '0')}${blue.toString(16).padStart(2, '0')}`;

            // æ¬¢ç¬‘å€¼è¶Šé«˜ï¼Œé‡‘è‰²å…‰æ™•è¶Šé‡ï¼Œæ„‰æ‚¦æ„Ÿè¶Šå¼º
            const opacity = joy / 100;
            body.style.boxShadow = `inset 0 0 200px rgba(255, 204, 0, ${opacity})`;

            // æ¬¢ç¬‘å€¼è¶…è¿‡80æ—¶æ·»åŠ å–œæ‚¦å‘¼å¸æ•ˆæœ
            body.style.animation = joy > 80 ? 'joyBreath 2s infinite ease-in-out' : '';
        }

        // ç”»é¢æ„‰æ‚¦æŠ–åŠ¨æ•ˆæœ
        function joyShakeScreen() {
            const shakeAmount = 8;
            const elements = [canvas, joyContainer, joyText, instructions, commentCard];

            elements.forEach(el => {
                const x = (Math.random() - 0.5) * shakeAmount;
                const y = (Math.random() - 0.5) * shakeAmount;

                if (el === canvas) {
                    el.style.transform = `translate(${x}px, ${y}px)`;
                } else if (el === joyContainer || el === commentCard) {
                    el.style.transform = `translate(${x}px, ${y}px) translateX(-50%)`;
                } else if (el === joyText || el === instructions) {
                    el.style.transform = `translate(${x}px, ${y}px) translateX(-50%)`;
                }
            });

            setTimeout(() => {
                canvas.style.transform = 'translate(0, 0)';
                joyContainer.style.transform = 'translateX(-50%)';
                joyText.style.transform = 'translateX(-50%)';
                instructions.style.transform = 'translateX(-50%)';
                commentCard.style.transform = 'translateX(-50%)';
            }, 100);
        }

        // ç”»é¢æ„‰æ‚¦é—ªçƒæ•ˆæœ
        function joyFlashScreen() {
            canvas.classList.add('flash-effect');
            setTimeout(() => {
                canvas.classList.remove('flash-effect');
            }, 200);
        }

        // æ›´æ–°è¯„è®ºå¡ç‰‡ï¼ˆå¸¦æ‰“å­—æœºæ•ˆæœï¼‰- æ¥æ”¶ä¸“å±è¯„è®ºå‚æ•°
        function updateCommentCard(type, comment) {
            // æ¸…é™¤ä¸Šä¸€ä¸ªæ‰“å­—æœºå®šæ—¶å™¨ï¼Œé˜²æ­¢é‡å¤åˆ·å±
            if (typingTimer) clearInterval(typingTimer);

            // è®¾ç½®å¤´åƒæ ·å¼å’Œè¡¨æƒ…
            switch(type) {
                case 'gray':
                    commentAvatar.style.backgroundColor = '#cccccc';
                    commentAvatar.style.boxShadow = '0 0 15px rgba(204, 204, 204, 0.5)';
                    commentAvatar.textContent = 'ğŸ˜';
                    commentAuthor.textContent = 'è·¯äºº';
                    commentAuthor.style.color = '#999999';
                    break;
                case 'red':
                    commentAvatar.style.backgroundColor = '#ff6666';
                    commentAvatar.style.boxShadow = '0 0 15px rgba(255, 102, 102, 0.7)';
                    commentAvatar.textContent = 'ğŸ™';
                    commentAuthor.textContent = 'è´Ÿé¢è¨€è®º';
                    commentAuthor.style.color = '#ff6666';
                    break;
                case 'green':
                    commentAvatar.style.backgroundColor = '#99cc00';
                    commentAvatar.style.boxShadow = '0 0 15px rgba(153, 204, 0, 0.7)';
                    commentAvatar.textContent = 'ğŸ˜Š';
                    commentAuthor.textContent = 'æš–å¿ƒè¯è¯­';
                    commentAuthor.style.color = '#99cc00';
                    break;
            }

            // æ‰“å­—æœºæ•ˆæœæ˜¾ç¤ºä¸“å±è¯„è®º
            commentText.textContent = '';
            let index = 0;
            typingTimer = setInterval(() => {
                if (index < comment.length) {
                    commentText.textContent += comment.charAt(index);
                    index++;
                } else {
                    clearInterval(typingTimer);
                    typingTimer = null;
                }
            }, 50);

            // å¤´åƒè„‰å†²åŠ¨ç”»
            commentAvatar.style.animation = 'pulse 0.6s ease';
            setTimeout(() => {
                commentAvatar.style.animation = '';
            }, 600);

            // å¡ç‰‡ç¼©æ”¾åé¦ˆ
            commentCard.style.transform = 'translateX(-50%) scale(1.05)';
            setTimeout(() => {
                commentCard.style.transform = 'translateX(-50%) scale(1)';
            }, 200);

            // åˆ›å»ºç²’å­æ•ˆæœ
            createParticles(mouseX, mouseY, type);
        }

        // æ‰¹é‡ç”Ÿæˆç»¿è‰²è¨€å¼¹ï¼ˆ18ç§’è§¦å‘ï¼‰
        function spawnMassiveGreenBullets() {
            // ä¸€æ¬¡æ€§ç”Ÿæˆ50ä¸ªç»¿è‰²è¨€å¼¹ï¼ˆå·¨é‡æŠ•æ”¾ï¼‰
            const massiveCount = 50;
            for (let i = 0; i < massiveCount; i++) {
                // åˆ†æ•£ç”Ÿæˆä½ç½®ï¼Œè®©è¨€å¼¹ä»å±å¹•å„ä¸ªæ–¹å‘è¢­æ¥
                const randomSide = Math.floor(Math.random() * 4);
                let x, y;

                switch(randomSide) {
                    case 0: // é¡¶éƒ¨
                        x = Math.random() * canvasWidth;
                        y = -50 - (Math.random() * 100);
                        break;
                    case 1: // å³ä¾§
                        x = canvasWidth + 50 + (Math.random() * 100);
                        y = Math.random() * canvasHeight;
                        break;
                    case 2: // åº•éƒ¨
                        x = Math.random() * canvasWidth;
                        y = canvasHeight + 50 + (Math.random() * 100);
                        break;
                    case 3: // å·¦ä¾§
                        x = -50 - (Math.random() * 100);
                        y = Math.random() * canvasHeight;
                        break;
                }

                const bullet = new Bullet('green');
                bullet.x = x;
                bullet.y = y;
                bullet.speed = bullet.speed * 1.2; // 18ç§’åç»¿å¼¹é€Ÿåº¦æå‡20%
                bullets.push(bullet);
            }

            // å¼ºåŒ–è§†è§‰æ•ˆæœï¼šå¢åŠ æ„‰æ‚¦æŠ–åŠ¨é¢‘ç‡å’Œå¼ºåº¦
            if (shakeInterval) clearInterval(shakeInterval);
            shakeInterval = setInterval(() => {
                joyShakeScreen();
                // é¢å¤–çš„æ„‰æ‚¦æŠ–åŠ¨
                setTimeout(joyShakeScreen, 50);
            }, 80);

            // å¼ºåŒ–é—ªçƒæ•ˆæœ
            if (flashInterval) clearInterval(flashInterval);
            flashInterval = setInterval(joyFlashScreen, 150);

            // èƒŒæ™¯å˜é‡‘è‰²ï¼Œå¼ºåŒ–æ„‰æ‚¦æ„Ÿ
            body.style.backgroundColor = '#fff8e0';
            body.style.boxShadow = 'inset 0 0 200px rgba(255, 204, 0, 0.8)';
        }

        // ========== è§¦æ‘¸äº‹ä»¶ç›¸å…³å˜é‡å’Œæ–¹æ³• ==========
        let isTouching = false; // æ˜¯å¦æ­£åœ¨è§¦æ‘¸å±å¹•

        // è§¦æ‘¸å¼€å§‹äº‹ä»¶
        function handleTouchStart(e) {
            if (!gameRunning) return;
            isTouching = true;
            // è·å–ç¬¬ä¸€ä¸ªè§¦æ‘¸ç‚¹çš„åæ ‡
            const touch = e.touches[0];
            mouseX = touch.clientX;
            mouseY = touch.clientY;
            updateControlBallPosition();
        }

        // è§¦æ‘¸ç§»åŠ¨äº‹ä»¶
        function handleTouchMove(e) {
            if (!gameRunning || !isTouching) return;
            e.preventDefault(); // é˜»æ­¢é¡µé¢æ»šåŠ¨ç­‰é»˜è®¤è¡Œä¸º
            const touch = e.touches[0];
            mouseX = touch.clientX;
            mouseY = touch.clientY;
            updateControlBallPosition();
        }

        // è§¦æ‘¸ç»“æŸäº‹ä»¶
        function handleTouchEnd() {
            isTouching = false;
            // ç§»åŠ¨ç«¯è§¦æ‘¸ç»“æŸåï¼Œå°çƒä»ä¿ç•™åœ¨æœ€åä½ç½®ï¼ˆå¯é€‰ï¼šä¹Ÿå¯é‡ç½®åˆ°ä¸­å¤®ï¼‰
            updateControlBallPosition();
        }

        // ========== æ¸¸æˆæ ¸å¿ƒé€»è¾‘ ==========
        // å¼€å§‹æ¸¸æˆï¼ˆç‚¹å‡»å¼¹çª—æŒ‰é’®åæ‰§è¡Œï¼‰
        function startGame() {
            // éšè—å¼€å§‹å¼¹çª—
            gameStartModal.style.display = 'none';
            // åˆå§‹åŒ–æ¸¸æˆ
            initGame();
        }

        // åˆå§‹åŒ–æ¸¸æˆ
        function initGame() {
            initAudio(); // åˆå§‹åŒ–éŸ³é¢‘
            resizeCanvas();
            joy = 0; // åˆå§‹æ¬¢ç¬‘å€¼ä¸º0
            bullets = [];
            gameTime = 0;
            gameRunning = true; // æ ‡è®°æ¸¸æˆå¼€å§‹è¿è¡Œ
            isJoy40Triggered = false;
            is18SecondsTriggered = false; // é‡ç½®18ç§’è§¦å‘æ ‡è®°
            lastFrameTime = 0;
            isTouching = false;

            // ç”µè„‘ç«¯éšè—é¼ æ ‡ï¼Œç§»åŠ¨ç«¯æ˜¾ç¤ºæ§åˆ¶å°çƒ
            if (isTouchDevice) {
                body.classList.remove('game-running'); // ç§»åŠ¨ç«¯æ— éœ€éšè—é¼ æ ‡
                controlBall.style.display = 'block'; // æ˜¾ç¤ºæ§åˆ¶å°çƒ
                updateControlBallPosition();
            } else {
                body.classList.add('game-running'); // ç”µè„‘ç«¯éšè—é¼ æ ‡
            }
            body.classList.remove('game-ended');

            // æ¸…é™¤å®šæ—¶å™¨
            if (shakeInterval) clearInterval(shakeInterval);
            if (flashInterval) clearInterval(flashInterval);

            // é‡ç½®æ ·å¼
            updateJoy();
            updateBackgroundColor();
            canvas.classList.remove('flash-effect');
            canvas.style.transform = 'translate(0, 0)';
            joyContainer.style.transform = 'translateX(-50%)';
            joyText.style.transform = 'translateX(-50%)';
            instructions.style.transform = 'translateX(-50%)';
            commentCard.style.transform = 'translateX(-50%)';

            gameWinModal.style.display = 'none';
            // åˆå§‹åŒ–é»˜è®¤è¯„è®º
            updateCommentCard('gray', 'ç­‰å¾…äº’åŠ¨...');

            // ç»‘å®šäº‹ä»¶
            window.addEventListener('resize', resizeCanvas);
            if (!isTouchDevice) {
                // ç”µè„‘ç«¯ï¼šé¼ æ ‡ç§»åŠ¨äº‹ä»¶
                canvas.addEventListener('mousemove', (e) => {
                    if (!gameRunning) return;
                    mouseX = e.clientX;
                    mouseY = e.clientY;
                });
            } else {
                // ç§»åŠ¨ç«¯ï¼šè§¦æ‘¸äº‹ä»¶
                canvas.addEventListener('touchstart', handleTouchStart);
                canvas.addEventListener('touchmove', handleTouchMove);
                canvas.addEventListener('touchend', handleTouchEnd);
            }

            animate();
        }

        // æ›´æ–°æ¬¢ç¬‘å€¼æ˜¾ç¤º
        function updateJoy() {
            joyBar.style.width = `${joy}%`;
            joyText.textContent = `æ¬¢ç¬‘å€¼: ${joy}`;

            // æ¬¢ç¬‘å€¼é¢œè‰²æ¸å˜
            if (joy < 40) {
                joyBar.style.background = 'linear-gradient(90deg, #FFE485, #FFD700)';
            } else if (joy < 70) {
                joyBar.style.background = 'linear-gradient(90deg, #FFD700, #FFC107)';
            } else {
                joyBar.style.background = 'linear-gradient(90deg, #FFC107, #FF8C00)';
            }

            updateBackgroundColor();

            // æ¬¢ç¬‘å€¼è¶…è¿‡60æ—¶å¯åŠ¨æ„‰æ‚¦æŠ–åŠ¨å’Œé—ªçƒ
            if (joy > 60 && gameRunning) {
                if (!shakeInterval) {
                    shakeInterval = setInterval(joyShakeScreen, 150);
                }
                if (!flashInterval) {
                    flashInterval = setInterval(joyFlashScreen, 300);
                }
            } else if (joy <= 60 && !is18SecondsTriggered) {
                if (shakeInterval) {
                    clearInterval(shakeInterval);
                    shakeInterval = null;
                }
                if (flashInterval) {
                    clearInterval(flashInterval);
                    flashInterval = null;
                }
            }

            // æ¸¸æˆèƒœåˆ©é€»è¾‘ï¼ˆæ¬¢ç¬‘å€¼è¾¾åˆ°100ï¼‰
            if (joy >= 100 && gameRunning) {
                gameRunning = false;
                // æ¸¸æˆèƒœåˆ©åï¼Œç§»åŠ¨ç«¯éšè—æ§åˆ¶å°çƒï¼Œç”µè„‘ç«¯æ˜¾ç¤ºé¼ æ ‡
                if (isTouchDevice) {
                    controlBall.style.display = 'none';
                } else {
                    body.classList.remove('game-running');
                }
                body.classList.add('game-ended');
                audio.gameWin.play(); // æ’­æ”¾æ¸¸æˆèƒœåˆ©éŸ³æ•ˆ
                gameWinModal.style.display = 'block';
                if (shakeInterval) clearInterval(shakeInterval);
                if (flashInterval) clearInterval(flashInterval);
            }
        }

        // è¨€å¼¹ç±»ï¼ˆå·®å¼‚åŒ–è¡Œä¸ºï¼‰
        class Bullet {
            constructor(type) {
                // åˆå§‹ä½ç½®
                this.x = Math.random() * canvasWidth;
                this.y = Math.random() > 0.5 ? -50 : canvasHeight + 50;

                // åŸºç¡€å±æ€§
                this.type = type;
                this.size = type === 'gray' ? 15 : (type === 'red' ? 20 : 18);

                // æ ¸å¿ƒä¿®æ”¹ï¼šæ¯ä¸ªè¨€å¼¹åˆ›å»ºæ—¶ç»‘å®šä¸“å±è¯„è®º
                this.comment = getRandomComment(type);

                // å·®å¼‚åŒ–é€Ÿåº¦å’Œè¡Œä¸º
                switch(type) {
                    case 'gray': // è·¯äººï¼šæœ€æ…¢ï¼Œéšæœºå¾˜å¾Š
                        this.speed = 2 + Math.random() * 3;
                        this.wander = true;
                        this.wanderAngle = Math.random() * Math.PI * 2;
                        this.wanderSpeed = 0.05;
                        break;
                    case 'red': // è´Ÿé¢è¨€è®ºï¼šä¸­é€Ÿï¼Œç›´å¥”ç›®æ ‡
                        this.speed = 4 + Math.random() * 4;
                        this.wander = false;
                        break;
                    case 'green': // æš–å¿ƒè¯è¯­ï¼šä¸­ç­‰é€Ÿåº¦ï¼Œè½»å¾®å¾˜å¾Š
                        this.speed = 3 + Math.random() * 3;
                        this.wander = true;
                        this.wanderAngle = Math.random() * Math.PI * 2;
                        this.wanderSpeed = 0.02;
                        break;
                }

                // æ¸å˜é¢œè‰²
                this.gradient = ctx.createRadialGradient(
                    this.x, this.y, 0,
                    this.x, this.y, this.size
                );
                switch(type) {
                    case 'gray':
                        this.gradient.addColorStop(0, '#eeeeee');
                        this.gradient.addColorStop(1, '#cccccc');
                        break;
                    case 'red':
                        this.gradient.addColorStop(0, '#ff9999');
                        this.gradient.addColorStop(1, '#ff6666');
                        break;
                    case 'green':
                        this.gradient.addColorStop(0, '#ccff99');
                        this.gradient.addColorStop(1, '#99cc00');
                        break;
                }
            }

            // æ›´æ–°è¨€å¼¹ä½ç½®ï¼ˆå¸¦å¾˜å¾Šæ•ˆæœï¼‰
            update() {
                let dx = mouseX - this.x;
                let dy = mouseY - this.y;

                // å¾˜å¾Šæ•ˆæœï¼ˆè·¯äºº/æš–å¿ƒè¯è¯­ï¼‰
                if (this.wander) {
                    this.wanderAngle += this.wanderSpeed;
                    dx += Math.cos(this.wanderAngle) * 15;
                    dy += Math.sin(this.wanderAngle) * 15;
                }

                const angle = Math.atan2(dy, dx);
                this.x += Math.cos(angle) * this.speed;
                this.y += Math.sin(angle) * this.speed;

                // æ›´æ–°æ¸å˜ä½ç½®
                this.gradient = ctx.createRadialGradient(
                    this.x, this.y, 0,
                    this.x, this.y, this.size
                );
                switch(this.type) {
                    case 'gray':
                        this.gradient.addColorStop(0, '#eeeeee');
                        this.gradient.addColorStop(1, '#cccccc');
                        break;
                    case 'red':
                        this.gradient.addColorStop(0, '#ff9999');
                        this.gradient.addColorStop(1, '#ff6666');
                        break;
                    case 'green':
                        this.gradient.addColorStop(0, '#ccff99');
                        this.gradient.addColorStop(1, '#99cc00');
                        break;
                }

                // ç¢°æ’æ£€æµ‹
                const distance = Math.sqrt(
                    Math.pow(mouseX - this.x, 2) +
                    Math.pow(mouseY - this.y, 2)
                );

                if (distance < 25) {
                    this.handleCollision();
                    return true;
                }

                // è¶…å‡ºå±å¹•ç§»é™¤
                if (this.x < -50 || this.x > canvasWidth + 50 ||
                    this.y < -50 || this.y > canvasHeight + 50) {
                    return true;
                }

                return false;
            }

            // ç¢°æ’å¤„ç†ï¼ˆå¸¦éŸ³æ•ˆï¼‰
            handleCollision() {
                if (!gameRunning) return;

                // æ’­æ”¾å¯¹åº”éŸ³æ•ˆ
                switch(this.type) {
                    case 'red':
                        audio.hitRed.currentTime = 0;
                        audio.hitRed.play().catch(e => console.log('éŸ³æ•ˆæ’­æ”¾å¤±è´¥'));
                        joy = Math.max(0, joy - 8); // è´Ÿé¢è¨€è®ºå‡å°‘8ç‚¹æ¬¢ç¬‘å€¼
                        break;
                    case 'green':
                        audio.hitGreen.currentTime = 0;
                        audio.hitGreen.play().catch(e => console.log('éŸ³æ•ˆæ’­æ”¾å¤±è´¥'));
                        joy = Math.min(100, joy + 12); // æš–å¿ƒè¯è¯­å¢åŠ 12ç‚¹æ¬¢ç¬‘å€¼
                        break;
                    case 'gray':
                        audio.hitGray.currentTime = 0;
                        audio.hitGray.play().catch(e => console.log('éŸ³æ•ˆæ’­æ”¾å¤±è´¥'));
                        break;
                }

                // ä¼ é€’å½“å‰è¨€å¼¹çš„ä¸“å±è¯„è®º
                updateCommentCard(this.type, this.comment);
                updateJoy();
            }

            // ç»˜åˆ¶è¨€å¼¹
            draw() {
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fillStyle = this.gradient;
                ctx.fill();

                // é«˜å…‰æ•ˆæœ
                ctx.beginPath();
                ctx.arc(this.x - this.size/3, this.y - this.size/3, this.size/4, 0, Math.PI * 2);
                ctx.fillStyle = 'rgba(255,255,255,0.7)';
                ctx.fill();

                // å¤–å‘å…‰æ•ˆæœ
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size + 2, 0, Math.PI * 2);
                ctx.fillStyle = `rgba(${this.type === 'red' ? 255 : this.type === 'green' ? 153 : 204},
                                    ${this.type === 'red' ? 102 : this.type === 'green' ? 204 : 204},
                                    ${this.type === 'red' ? 102 : this.type === 'green' ? 0 : 204}, 0.2)`;
                ctx.fill();
            }
        }

        // ç”Ÿæˆè¨€å¼¹ï¼ˆè°ƒæ•´æ¦‚ç‡ï¼Œç»¿è‰²è¨€å¼¹æ›´å¤šï¼‰
        function spawnBullets() {
            gameTime++;

            // 18ç§’ï¼ˆ1080å¸§ï¼‰è§¦å‘å·¨é‡ç»¿è‰²è¨€å¼¹ï¼ˆä»…è§¦å‘ä¸€æ¬¡ï¼‰
            if (gameTime >= 1080 && !is18SecondsTriggered) {
                is18SecondsTriggered = true;
                spawnMassiveGreenBullets();
            }

            // é™åˆ¶æœ€å¤§è¨€å¼¹æ•°é‡ï¼Œé˜²æ­¢å¡é¡¿
            if (bullets.length > 200) return;

            // åŸºç¡€ç”Ÿæˆè§„åˆ™ï¼ˆç»¿è‰²è¨€å¼¹æ¦‚ç‡æ›´é«˜ï¼‰
            let redChance = 0.15;    // çº¢è‰²ï¼š15%
            let greenChance = 0.55;  // ç»¿è‰²ï¼š55%ï¼ˆä¸»è¦æ”¶é›†ç›®æ ‡ï¼‰
            let grayChance = 0.3;    // ç°è‰²ï¼š30%
            let spawnRate = 5;

            // é˜¶æ®µéš¾åº¦è°ƒæ•´
            if (gameTime > 600) {
                redChance = 0.25;     // çº¢è‰²ï¼š25%
                greenChance = 0.5;    // ç»¿è‰²ï¼š50%
                grayChance = 0.25;    // ç°è‰²ï¼š25%
                spawnRate = 7;
            }

            if (gameTime > 1800) {
                redChance = 0.35;     // çº¢è‰²ï¼š35%
                greenChance = 0.45;   // ç»¿è‰²ï¼š45%
                grayChance = 0.2;     // ç°è‰²ï¼š20%
                spawnRate = 9;
            }

            // æ¬¢ç¬‘å€¼è¶…è¿‡40æ—¶å¢åŠ ç»¿è‰²è¨€å¼¹æ¦‚ç‡
            if (joy > 40) {
                if (!isJoy40Triggered) {
                    isJoy40Triggered = true;
                }
                redChance = 0.2;      // çº¢è‰²ï¼š20%
                greenChance = 0.7;    // ç»¿è‰²ï¼š70%ï¼ˆæ›´å®¹æ˜“æ”¶é›†ï¼‰
                grayChance = 0.1;     // ç°è‰²ï¼š10%
                spawnRate = 11;
            }

            // 18ç§’åæŒç»­é«˜æ¦‚ç‡ç”Ÿæˆç»¿è‰²è¨€å¼¹
            if (is18SecondsTriggered) {
                redChance = 0.15;     // çº¢è‰²ï¼š15%
                greenChance = 0.8;    // ç»¿è‰²ï¼š80%
                grayChance = 0.05;    // ç°è‰²ï¼š5%
                spawnRate = 15;
            }

            // éšæœºç”Ÿæˆè¨€å¼¹
            if (Math.random() < spawnRate / 60) {
                let rand = Math.random();
                let type;

                if (rand < redChance) {
                    type = 'red';
                } else if (rand < redChance + greenChance) {
                    type = 'green';
                } else {
                    type = 'gray';
                }

                bullets.push(new Bullet(type));
            }
        }

        // æ¸¸æˆåŠ¨ç”»å¾ªç¯ï¼ˆå¸§ç‡æ§åˆ¶ï¼‰
        function animate(timestamp) {
            if (!gameRunning) return;

            // æ§åˆ¶å¸§ç‡ï¼ˆçº¦60fpsï¼‰
            const delta = timestamp - lastFrameTime;
            if (delta < 16) {
                requestAnimationFrame(animate);
                return;
            }
            lastFrameTime = timestamp;

            // æ¸…ç©ºç”»å¸ƒ
            ctx.clearRect(0, 0, canvasWidth, canvasHeight);

            // ç”Ÿæˆæ–°è¨€å¼¹
            spawnBullets();

            // æ›´æ–°å’Œç»˜åˆ¶æ‰€æœ‰è¨€å¼¹
            for (let i = bullets.length - 1; i >= 0; i--) {
                const bullet = bullets[i];
                bullet.draw();
                if (bullet.update()) {
                    bullets.splice(i, 1);
                }
            }

            // ç»˜åˆ¶è‡ªå®šä¹‰å…‰æ ‡/è§¦æ‘¸æ ‡è®°ï¼ˆç§»åŠ¨ç«¯éšè—ï¼Œç”¨æ§åˆ¶å°çƒæ›¿ä»£ï¼‰
            if (!isTouchDevice) {
                ctx.beginPath();
                ctx.arc(mouseX, mouseY, 15, 0, Math.PI * 2);
                ctx.strokeStyle = 'rgba(255, 140, 0, 0.9)';
                ctx.lineWidth = 3;
                ctx.stroke();
                ctx.beginPath();
                ctx.arc(mouseX, mouseY, 18, 0, Math.PI * 2);
                ctx.strokeStyle = 'rgba(255, 140, 0, 0.4)';
                ctx.lineWidth = 1;
                ctx.stroke();
            }

            requestAnimationFrame(animate);
        }

        // ç¡®è®¤æ¸¸æˆèƒœåˆ©å¹¶è·³è½¬åˆ°æŒ‡å®šç½‘é¡µ
        function confirmGameWin() {
            // éšè—å¼¹çª—
            gameWinModal.style.display = 'none';
            // è·³è½¬åˆ°ç›®æ ‡ç½‘å€
            window.location.href = TARGET_URL;
        }

        // é¡µé¢åŠ è½½å®Œæˆåä»…æ˜¾ç¤ºå¼€å§‹å¼¹çª—ï¼Œä¸è‡ªåŠ¨åˆå§‹åŒ–æ¸¸æˆ
        window.onload = function() {
            // ä»…åˆå§‹åŒ–ç”»å¸ƒå¤§å°ï¼Œä¸å¯åŠ¨æ¸¸æˆå¾ªç¯
            resizeCanvas();
            // ç»‘å®šé¼ æ ‡ç§»åŠ¨äº‹ä»¶ï¼ˆç”µè„‘ç«¯ï¼‰
            if (!isTouchDevice) {
                canvas.addEventListener('mousemove', (e) => {
                    mouseX = e.clientX;
                    mouseY = e.clientY;
                });
            }
        };
    </script>
</body>
</html>

